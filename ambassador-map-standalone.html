<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Interaktywna mapa polskich placówek dyplomatycznych na całym świecie z informacjami o ambasadorach">
    <title>Mapa Ambasadorów i Kierowników - Instytut Nowej Europy</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
          integrity="sha512-iecdLmaskl7CVkqk1w20xCyyuj76JJNCdRN4hQFZu8JC1Dz5hM5c9gJbYVrHE6vkPgABm7K7F5VTqIr6F3FvQ=="
          crossorigin="anonymous"
          referrerpolicy="no-referrer" />

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --ine-gold: #C4A462;
            --ine-gold-light: #e0cba0;
            --ine-contrast: #5F6F81;
            --ine-black: #1a1a1a;
            --ine-bg-gray: #f9fafb;
        }

        body {
            font-family: 'Lato', sans-serif;
            color: #333;
        }

        h1, h2, h3, .font-heading {
            font-family: 'Montserrat', sans-serif;
        }

        /* Utilities */
        .text-gold { color: var(--ine-gold); }
        .bg-gold { background-color: var(--ine-gold); }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

        /* Filter Pills */
        .filter-pill {
            transition: all 0.3s ease;
            border: 1px solid #e5e7eb;
            background: white;
            color: #6b7280;
        }
        .filter-pill:hover {
            border-color: var(--ine-gold);
            color: var(--ine-gold);
        }
        .filter-pill.active {
            background-color: var(--ine-black);
            color: var(--ine-gold);
            border-color: var(--ine-black);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* List Item Styling */
        .list-item {
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }
        .list-item:hover {
            background-color: #fcfcfc;
            border-left-color: var(--ine-gold-light);
            transform: translateX(4px);
        }
        .list-item.active-item {
            background-color: #fffbeb;
            border-left-color: var(--ine-gold);
        }

        /* Info Panel */
        .info-panel {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            box-shadow: -10px 0 25px -5px rgba(0, 0, 0, 0.1);
        }

        /* Checkbox styling */
        .custom-checkbox input:checked + div {
            background-color: var(--ine-gold);
            border-color: var(--ine-gold);
        }
        .custom-checkbox input:checked + div svg {
            display: block;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }

        /* Pin Styling */
        .custom-pin-icon {
            pointer-events: auto !important;
        }

        .pin-outer {
            position: relative;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
        }

        .pin-outer:hover {
            transform: scale(1.15) translateY(-5px);
            z-index: 10000 !important;
        }

        .pin-body {
            width: 30px;
            height: 30px;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            border: 2px solid #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .pin-body::after {
            content: '';
            width: 8px;
            height: 8px;
            background: #ffffff;
            border-radius: 50%;
            position: absolute;
        }

        .pin-gradient-gold {
            background: linear-gradient(135deg, #FFD700 0%, #C4A462 100%);
        }
        .pin-gradient-contrast {
            background: linear-gradient(135deg, #8E9EAB 0%, #5F6F81 100%);
        }

        .dot-ambassador { background-color: var(--ine-gold); }
        .dot-charge { background-color: var(--ine-contrast); }

        /* Loading State */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        /* Error State */
        .error-message {
            background: #fee;
            border: 1px solid #fcc;
            padding: 1rem;
            border-radius: 4px;
            color: #c33;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #9ca3af;
        }

        /* Skip to content for accessibility */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--ine-black);
            color: var(--ine-gold);
            padding: 8px;
            z-index: 100;
        }
        .skip-link:focus {
            top: 0;
        }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col overflow-hidden">

    <!-- Skip to content link for accessibility -->
    <a href="#main-content" class="skip-link" aria-label="Przejdź do głównej zawartości">
        Przejdź do głównej zawartości
    </a>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" aria-live="polite" aria-atomic="true">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-[color:var(--ine-gold)] mx-auto"></div>
            <p class="mt-4 text-gray-600">Ładowanie mapy...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white text-black h-16 shadow-sm z-30 flex justify-between items-center px-6 border-b border-gray-100 relative" role="banner">
        <div class="flex items-center gap-4">
            <div class="flex items-center justify-center w-10 h-10 border border-[color:var(--ine-gold)] text-[color:var(--ine-gold)] rounded-sm" aria-hidden="true">
                <i class="fas fa-book-open text-lg"></i>
            </div>
            <div class="flex flex-col">
                <h1 class="text-lg font-bold tracking-wide text-black uppercase font-heading leading-tight">Instytut Nowej Europy</h1>
                <p class="text-[10px] text-[color:var(--ine-gold)] font-bold tracking-[0.2em] uppercase mt-0.5">Mapa Ambasadorów</p>
            </div>
        </div>

        <div class="hidden md:flex items-center gap-6">
            <div class="text-right">
                <p class="text-xs text-gray-400 font-light uppercase tracking-wider">Aktualizacja</p>
                <p class="text-xs font-medium text-gray-700">Rok 2025</p>
            </div>
            <div class="h-8 w-px bg-gray-200" aria-hidden="true"></div>
            <a href="https://ine.org.pl" target="_blank" rel="noopener noreferrer"
               class="text-xs font-semibold text-gray-500 hover:text-[color:var(--ine-gold)] transition-colors flex items-center gap-2 group"
               aria-label="Odwiedź stronę Instytutu Nowej Europy">
                ine.org.pl
                <span class="w-6 h-6 rounded-full bg-gray-100 group-hover:bg-[color:var(--ine-gold)] group-hover:text-white flex items-center justify-center transition-all" aria-hidden="true">
                    <i class="fas fa-arrow-right text-[10px]"></i>
                </span>
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex flex-1 relative overflow-hidden" id="main-content">

        <!-- Sidebar -->
        <aside class="w-full md:w-[400px] bg-white z-20 flex flex-col absolute md:relative h-full transition-transform duration-500 transform -translate-x-full md:translate-x-0 shadow-[4px_0_24px_rgba(0,0,0,0.02)]"
               id="sidebar"
               role="complementary"
               aria-label="Panel filtrowania i listy placówek">

            <!-- Filters & Search Area -->
            <div class="p-6 bg-white border-b border-gray-100 z-10 relative">
                <!-- Search Input -->
                <div class="relative mb-6 group">
                    <label for="searchInput" class="sr-only">Wyszukaj kraj lub nazwisko</label>
                    <input type="text"
                           id="searchInput"
                           placeholder="Szukaj kraju, nazwiska..."
                           class="w-full pl-11 pr-4 py-3 bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-sm focus:outline-none focus:bg-white focus:border-[color:var(--ine-gold)] focus:ring-0 transition-all placeholder-gray-400 font-light"
                           aria-describedby="searchHelp">
                    <i class="fas fa-search absolute left-4 top-3.5 text-gray-400 group-focus-within:text-[color:var(--ine-gold)] transition-colors" aria-hidden="true"></i>
                    <span id="searchHelp" class="sr-only">Wpisz tekst aby przefiltrować listę placówek</span>
                </div>

                <!-- Stats / Filters -->
                <div>
                    <div class="flex justify-between items-end mb-3">
                        <h3 class="text-[10px] font-bold uppercase tracking-widest text-gray-400 font-heading">Filtruj wg płci</h3>
                    </div>

                    <div class="grid grid-cols-3 gap-3 mb-5" role="group" aria-label="Filtry według płci">
                        <button id="filterAll"
                                class="filter-pill active py-2 px-1 rounded-sm text-center flex flex-col items-center justify-center gap-1 group"
                                onclick="AmbassadorMap.setGenderFilter('all')"
                                aria-pressed="true"
                                aria-label="Pokaż wszystkich">
                            <span class="text-[10px] font-bold uppercase tracking-wide opacity-70">Wszyscy</span>
                            <span class="text-sm font-heading font-bold" id="countAll" aria-live="polite">0</span>
                        </button>
                        <button id="filterWomen"
                                class="filter-pill py-2 px-1 rounded-sm text-center flex flex-col items-center justify-center gap-1 group"
                                onclick="AmbassadorMap.setGenderFilter('F')"
                                aria-pressed="false"
                                aria-label="Pokaż tylko kobiety">
                            <span class="text-[10px] font-bold uppercase tracking-wide opacity-70">Kobiety</span>
                            <span class="text-sm font-heading font-bold" id="countWomen" aria-live="polite">0</span>
                        </button>
                        <button id="filterMen"
                                class="filter-pill py-2 px-1 rounded-sm text-center flex flex-col items-center justify-center gap-1 group"
                                onclick="AmbassadorMap.setGenderFilter('M')"
                                aria-pressed="false"
                                aria-label="Pokaż tylko mężczyzn">
                            <span class="text-[10px] font-bold uppercase tracking-wide opacity-70">Mężczyźni</span>
                            <span class="text-sm font-heading font-bold" id="countMen" aria-live="polite">0</span>
                        </button>
                    </div>

                    <label class="custom-checkbox flex items-center cursor-pointer select-none group py-2 px-3 border border-dashed border-gray-200 rounded-sm hover:border-gray-300 transition-colors">
                        <input type="checkbox"
                               id="ageFilter"
                               class="hidden"
                               onchange="AmbassadorMap.toggleAgeFilter()"
                               aria-describedby="ageFilterDesc">
                        <div class="w-4 h-4 border border-gray-300 rounded-sm flex items-center justify-center bg-white transition-colors mr-3 group-hover:border-[color:var(--ine-gold)]" aria-hidden="true">
                            <svg class="w-2.5 h-2.5 text-white hidden pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <span class="block text-xs font-semibold text-gray-700">Wiek emerytalny / ochronny</span>
                            <span id="ageFilterDesc" class="text-[10px] text-gray-400 font-light">Mężczyźni: 60+, Kobiety: 55+</span>
                        </div>
                        <span class="text-xs font-bold text-[color:var(--ine-gold)]" id="countAge" aria-live="polite">0</span>
                    </label>
                </div>
            </div>

            <!-- List Container -->
            <div id="countryList"
                 class="overflow-y-auto flex-1 p-0 custom-scrollbar bg-white pb-10"
                 role="list"
                 aria-live="polite"
                 aria-label="Lista placówek dyplomatycznych">
                <!-- List Items injected via JS -->
            </div>

            <!-- Mobile Close -->
            <button id="closeSidebarBtn"
                    class="md:hidden absolute top-2 right-2 text-gray-400 hover:text-black p-2"
                    aria-label="Zamknij panel boczny">
                <i class="fas fa-times text-xl" aria-hidden="true"></i>
            </button>
        </aside>

        <!-- Map Area -->
        <main class="flex-1 h-full relative bg-gray-50" role="main">
            <div id="map" class="w-full h-full z-0" role="application" aria-label="Interaktywna mapa świata z lokalizacjami placówek"></div>

            <!-- Mobile Toggle -->
            <button id="sidebarToggle"
                    class="md:hidden absolute top-4 left-4 bg-white text-black border border-gray-200 p-3 rounded-full shadow-lg z-[400] text-[color:var(--ine-gold)]"
                    aria-label="Otwórz panel filtrów"
                    aria-expanded="false"
                    aria-controls="sidebar">
                <i class="fas fa-list" aria-hidden="true"></i>
            </button>

            <!-- Legend Overlay -->
            <div class="absolute bottom-8 left-8 z-[400] bg-white/90 backdrop-blur-sm p-4 rounded-sm shadow-lg border-l-2 border-[color:var(--ine-gold)] hidden md:block"
                 role="complementary"
                 aria-label="Legenda mapy">
                <h4 class="text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-3">Legenda</h4>
                <div class="flex items-center gap-3 mb-2">
                    <span class="w-3 h-3 rounded-full dot-ambassador shadow-sm" aria-hidden="true"></span>
                    <span class="text-xs font-medium text-gray-700">Ambasador RP</span>
                </div>
                <div class="flex items-center gap-3 mb-2">
                    <span class="w-3 h-3 rounded-full dot-charge shadow-sm" aria-hidden="true"></span>
                    <span class="text-xs font-medium text-gray-700">Chargé d'affaires / Inne</span>
                </div>
                <div class="flex items-center gap-3">
                    <div class="w-3 h-3 border-2 border-[color:var(--ine-gold)] rounded-sm" aria-hidden="true"></div>
                    <span class="text-xs font-medium text-gray-700">Placówki Międzynarodowe</span>
                </div>
            </div>

            <!-- Info Panel (Overlay) -->
            <div id="infoPanel"
                 class="info-panel absolute top-0 right-0 h-full w-full md:w-[480px] z-[500] transform translate-x-full transition-transform duration-500 ease-in-out border-l border-white/20"
                 role="dialog"
                 aria-labelledby="panelCountry"
                 aria-hidden="true">
                <div class="h-full flex flex-col relative">
                    <!-- Close Button -->
                    <button id="closePanel"
                            class="absolute top-4 right-4 z-20 w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-500 hover:text-black transition-all"
                            aria-label="Zamknij panel informacyjny">
                        <i class="fas fa-times text-sm" aria-hidden="true"></i>
                    </button>

                    <!-- Header Image / Pattern Area -->
                    <div class="bg-[color:var(--ine-black)] h-40 flex items-end p-8 relative overflow-hidden">
                        <div class="absolute -top-10 -right-10 w-40 h-40 border-2 border-white/5 rounded-full" aria-hidden="true"></div>
                        <div class="absolute top-10 right-20 w-20 h-20 border border-white/5 rounded-full" aria-hidden="true"></div>

                        <div class="relative z-10 w-full">
                            <span class="inline-block px-2 py-1 bg-[color:var(--ine-gold)] text-black text-[9px] font-bold tracking-widest uppercase mb-2 rounded-sm" id="panelRegion">AMBASADA RP</span>
                            <h2 class="text-3xl text-white font-heading font-light tracking-wide" id="panelCountry">Kraj</h2>
                            <p class="text-white/80 text-sm font-light mt-1" id="panelCity"><i class="fas fa-map-marker-alt mr-1" aria-hidden="true"></i> Miasto</p>
                        </div>
                    </div>

                    <!-- Content -->
                    <div class="flex-1 overflow-y-auto custom-scrollbar p-8 bg-white relative">
                        <!-- Rank Icon Floating -->
                        <div class="absolute -top-8 right-8 w-16 h-16 rounded-full bg-white shadow-xl flex items-center justify-center border-4 border-white z-10" aria-hidden="true">
                            <div id="panelIconBg" class="w-full h-full rounded-full flex items-center justify-center text-white text-xl">
                                <i class="fas fa-user-tie"></i>
                            </div>
                        </div>

                        <div class="mt-4 animate-fade-in">
                            <h3 class="text-2xl font-bold text-gray-900 font-heading mb-1" id="panelName">Imię Nazwisko</h3>

                            <div class="flex items-center gap-3 mb-6">
                                <p class="text-sm font-bold text-[color:var(--ine-gold)] uppercase tracking-wider" id="panelTitle">Stanowisko</p>
                                <span id="panelAge" class="hidden text-[10px] bg-gray-100 text-gray-500 font-bold px-2 py-0.5 rounded-full border border-gray-200"></span>
                            </div>

                            <div class="h-px w-full bg-gradient-to-r from-[color:var(--ine-gold)] to-transparent mb-6 opacity-30" aria-hidden="true"></div>

                            <div class="prose prose-sm prose-gray max-w-none text-gray-600 font-light leading-relaxed text-justify" id="panelBio">
                                <!-- Bio content -->
                            </div>
                        </div>
                    </div>

                    <!-- Footer of panel -->
                    <div class="p-4 bg-gray-50 border-t border-gray-100 text-center">
                        <p class="text-[10px] text-gray-400 uppercase tracking-widest">Misja Dyplomatyczna</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <script>
        /**
         * Ambassador Map Application
         * Manages the interactive map of Polish diplomatic posts worldwide
         */
        const AmbassadorMap = (function() {
            'use strict';

            // Application state
            const state = {
                gender: 'all',
                ageFilter: false,
                searchTerm: '',
                ambassadors: [],
                locations: {},
                config: {},
                map: null,
                geoJsonLayer: null,
                markers: [],
                isLoading: true
            };

            // DOM elements (cached for performance)
            const elements = {
                loadingOverlay: null,
                searchInput: null,
                countryList: null,
                infoPanel: null,
                sidebar: null,
                sidebarToggle: null,
                closeSidebarBtn: null,
                closePanel: null,
                filterAll: null,
                filterWomen: null,
                filterMen: null,
                ageFilter: null
            };

            /**
             * Debounce function to limit the rate of function execution
             */
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            /**
             * Cache DOM elements on initialization
             */
            function cacheElements() {
                elements.loadingOverlay = document.getElementById('loadingOverlay');
                elements.searchInput = document.getElementById('searchInput');
                elements.countryList = document.getElementById('countryList');
                elements.infoPanel = document.getElementById('infoPanel');
                elements.sidebar = document.getElementById('sidebar');
                elements.sidebarToggle = document.getElementById('sidebarToggle');
                elements.closeSidebarBtn = document.getElementById('closeSidebarBtn');
                elements.closePanel = document.getElementById('closePanel');
                elements.filterAll = document.getElementById('filterAll');
                elements.filterWomen = document.getElementById('filterWomen');
                elements.filterMen = document.getElementById('filterMen');
                elements.ageFilter = document.getElementById('ageFilter');
            }

            /**
             * Load data from JSON files with error handling
             */
            async function loadData() {
                try {
                    const [ambassadorsRes, locationsRes, configRes] = await Promise.all([
                        fetch('./data/ambassadors.json'),
                        fetch('./data/locations.json'),
                        fetch('./data/config.json')
                    ]);

                    if (!ambassadorsRes.ok || !locationsRes.ok || !configRes.ok) {
                        throw new Error('Nie udało się pobrać danych');
                    }

                    state.ambassadors = await ambassadorsRes.json();
                    state.locations = await locationsRes.json();
                    state.config = await configRes.json();

                    // Process ambassador data - infer gender from first name
                    state.ambassadors.forEach(item => {
                        const firstName = item.name.split(' ')[0];
                        item.gender = firstName.endsWith('a') ? 'F' : 'M';
                    });

                    return true;
                } catch (error) {
                    console.error('Error loading data:', error);
                    showError('Nie udało się załadować danych. Proszę odświeżyć stronę.');
                    return false;
                }
            }

            /**
             * Display error message to user
             */
            function showError(message) {
                elements.loadingOverlay.innerHTML = `
                    <div class="error-message">
                        <h3 class="font-bold mb-2">Wystąpił błąd</h3>
                        <p>${message}</p>
                        <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-gray-800 text-white rounded">
                            Odśwież stronę
                        </button>
                    </div>
                `;
            }

            /**
             * Hide loading overlay
             */
            function hideLoading() {
                if (elements.loadingOverlay) {
                    elements.loadingOverlay.style.display = 'none';
                }
                state.isLoading = false;
            }

            /**
             * Initialize the Leaflet map
             */
            function initMap() {
                try {
                    state.map = L.map('map', { zoomControl: false }).setView([40.0, 20.0], 3);
                    L.control.zoom({ position: 'bottomright' }).addTo(state.map);

                    // Add tile layer
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
                        subdomains: 'abcd',
                        maxZoom: 20
                    }).addTo(state.map);

                    return true;
                } catch (error) {
                    console.error('Error initializing map:', error);
                    showError('Nie udało się zainicjalizować mapy.');
                    return false;
                }
            }

            /**
             * Load and render GeoJSON country boundaries
             */
            async function loadGeoJSON() {
                try {
                    const response = await fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json');
                    if (!response.ok) throw new Error('Failed to fetch GeoJSON');

                    const geoJsonData = await response.json();
                    state.geoJsonLayer = L.geoJSON(geoJsonData, {
                        style: styleFeature,
                        onEachFeature: onEachFeature
                    }).addTo(state.map);

                    return true;
                } catch (error) {
                    console.error('Error loading GeoJSON:', error);
                    // Non-fatal error - map can work without country boundaries
                    return false;
                }
            }

            /**
             * Get rank-based color styling
             */
            function getRankColor(title) {
                const lowerTitle = title.toLowerCase();
                if (lowerTitle.includes("ambasador") || lowerTitle.includes("stały przedstawiciel")) {
                    return {
                        color: state.config.colors.ambassador,
                        class: 'pin-gradient-gold'
                    };
                }
                return {
                    color: state.config.colors.charge,
                    class: 'pin-gradient-contrast'
                };
            }

            /**
             * Style GeoJSON features (countries) based on ambassador data
             */
            function styleFeature(feature) {
                const englishName = feature.properties.name;
                const polName = Object.keys(state.config.countryMapping).find(
                    key => state.config.countryMapping[key] === englishName
                );

                if (polName) {
                    const ambData = state.ambassadors.find(d => d.country === polName);
                    if (ambData && meetsCriteria(ambData)) {
                        const rank = getRankColor(ambData.title);
                        return {
                            fillColor: rank.color,
                            weight: 1,
                            opacity: 1,
                            color: 'white',
                            fillOpacity: 0.4
                        };
                    }
                }
                return {
                    fillColor: '#f9f9f9',
                    weight: 0.5,
                    opacity: 1,
                    color: '#ddd',
                    fillOpacity: 0.3
                };
            }

            /**
             * Attach event handlers to GeoJSON features
             */
            function onEachFeature(feature, layer) {
                const englishName = feature.properties.name;
                const polName = Object.keys(state.config.countryMapping).find(
                    key => state.config.countryMapping[key] === englishName
                );

                if (polName) {
                    const ambData = state.ambassadors.find(d => d.country === polName);
                    if (ambData) {
                        layer.ambData = ambData;

                        layer.on('click', function() {
                            if (meetsCriteria(ambData)) {
                                const rank = getRankColor(ambData.title);
                                showInfoPanel(ambData, rank);
                                state.map.flyTo(layer.getBounds().getCenter(), 5);
                                if (window.innerWidth < 768) toggleSidebar(false);
                            }
                        });

                        layer.on('mouseover', function() {
                            if (meetsCriteria(ambData)) {
                                layer.setStyle({ fillOpacity: 0.6, weight: 2, color: '#C4A462' });
                            }
                        });

                        layer.on('mouseout', function() {
                            if (meetsCriteria(ambData)) {
                                layer.setStyle({ fillOpacity: 0.4, weight: 1, color: 'white' });
                            }
                        });
                    }
                }
            }

            /**
             * Add markers for diplomatic posts
             */
            function addMarkers() {
                // Clear existing markers
                state.markers.forEach(marker => state.map.removeLayer(marker));
                state.markers = [];

                state.ambassadors.forEach(item => {
                    if (!meetsCriteria(item)) return;

                    // Determine coordinates
                    let lat = item.lat;
                    let lng = item.lng;

                    if (!lat && state.locations[item.country]) {
                        lat = state.locations[item.country][0];
                        lng = state.locations[item.country][1];
                    } else if (!lat && state.locations[item.city]) {
                        lat = state.locations[item.city][0];
                        lng = state.locations[item.city][1];
                    }

                    if (lat && lng) {
                        const rank = getRankColor(item.title);

                        const pinHtml = `
                            <div class="pin-outer">
                                <div class="pin-body ${rank.class}"></div>
                            </div>
                        `;

                        const customIcon = L.divIcon({
                            className: 'custom-pin-icon',
                            html: pinHtml,
                            iconSize: [36, 36],
                            iconAnchor: [18, 36]
                        });

                        const marker = L.marker([lat, lng], { icon: customIcon }).addTo(state.map);
                        marker.on('click', () => {
                            showInfoPanel(item, rank);
                            state.map.flyTo([lat, lng], 8, { animate: true, duration: 1.0 });
                        });

                        state.markers.push(marker);
                    }
                });
            }

            /**
             * Check if retirement age
             */
            function isRetirementAge(data) {
                if (data.age === null) return false;
                if (data.gender === 'F' && data.age >= 55) return true;
                if (data.gender === 'M' && data.age >= 60) return true;
                return false;
            }

            /**
             * Check if ambassador meets filter criteria
             */
            function meetsCriteria(data) {
                if (state.gender !== 'all' && data.gender !== state.gender) return false;
                if (state.ageFilter && !isRetirementAge(data)) return false;
                return true;
            }

            /**
             * Calculate and update statistics
             */
            function calculateStats() {
                const totalAll = state.ambassadors.length;
                const totalWomen = state.ambassadors.filter(d => d.gender === 'F').length;
                const totalMen = state.ambassadors.filter(d => d.gender === 'M').length;

                document.getElementById('countAll').textContent = totalAll;
                document.getElementById('countWomen').textContent = totalWomen;
                document.getElementById('countMen').textContent = totalMen;

                const ageCount = state.ambassadors.filter(isRetirementAge).length;
                document.getElementById('countAge').textContent = ageCount;
            }

            /**
             * Update view when filters change
             */
            function updateView() {
                if (state.geoJsonLayer) {
                    state.geoJsonLayer.setStyle(styleFeature);
                }
                addMarkers();
                renderList();
            }

            /**
             * Render the list of diplomatic posts
             */
            function renderList() {
                elements.countryList.innerHTML = '';
                const sorted = [...state.ambassadors].sort((a, b) => a.country.localeCompare(b.country));
                const searchTerm = state.searchTerm.toLowerCase();

                let visibleCount = 0;

                sorted.forEach((amb) => {
                    if (!meetsCriteria(amb)) return;

                    const match = amb.country.toLowerCase().includes(searchTerm) ||
                                  amb.name.toLowerCase().includes(searchTerm);
                    if (!match) return;

                    visibleCount++;

                    const rank = getRankColor(amb.title);

                    const li = document.createElement('div');
                    li.className = 'list-item p-4 border-b border-gray-50 cursor-pointer group';
                    li.setAttribute('role', 'listitem');
                    li.setAttribute('tabindex', '0');
                    li.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-heading font-bold text-gray-800 text-sm group-hover:text-[color:var(--ine-gold)] transition-colors">${amb.country}</div>
                                <div class="text-xs text-gray-500 mt-1 font-light">${amb.name}</div>
                            </div>
                            <div class="flex flex-col items-end gap-1">
                                <div class="w-2 h-2 rounded-full ${rank.class === 'pin-gradient-gold' ? 'dot-ambassador' : 'dot-charge'}" aria-hidden="true"></div>
                                ${amb.age ? `<span class="text-[9px] text-gray-300 font-bold bg-gray-50 px-1.5 py-0.5 rounded-sm">${amb.age} lat</span>` : ''}
                            </div>
                        </div>
                    `;

                    const clickHandler = () => focusOnAmbassador(amb, li);
                    li.onclick = clickHandler;
                    li.onkeypress = (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            clickHandler();
                        }
                    };

                    elements.countryList.appendChild(li);
                });

                // Show empty state if no results
                if (visibleCount === 0) {
                    elements.countryList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-search text-4xl mb-4" aria-hidden="true"></i>
                            <p class="text-sm font-medium">Nie znaleziono placówek</p>
                            <p class="text-xs mt-2">Spróbuj zmienić kryteria wyszukiwania</p>
                        </div>
                    `;
                }
            }

            /**
             * Focus on a specific ambassador
             */
            function focusOnAmbassador(data, liElement) {
                // Highlight list item
                document.querySelectorAll('.list-item').forEach(el => el.classList.remove('active-item'));
                if (liElement) liElement.classList.add('active-item');

                const rank = getRankColor(data.title);
                showInfoPanel(data, rank);

                let targetCoords = null;
                if (data.lat && data.lng) {
                    targetCoords = [data.lat, data.lng];
                } else if (state.locations[data.country]) {
                    targetCoords = state.locations[data.country];
                } else if (state.locations[data.city]) {
                    targetCoords = state.locations[data.city];
                }

                if (targetCoords) {
                    state.map.flyTo(targetCoords, 6, { animate: true, duration: 1.2 });
                }

                if (window.innerWidth < 768) toggleSidebar(false);
            }

            /**
             * Show information panel for selected post
             */
            function showInfoPanel(data, rank) {
                document.getElementById('panelCountry').textContent = data.country;
                document.getElementById('panelCity').innerHTML = `<i class="fas fa-map-marker-alt mr-1"></i> ${data.city}`;
                document.getElementById('panelName').textContent = data.name;
                document.getElementById('panelTitle').textContent = data.title;
                document.getElementById('panelBio').innerHTML = data.bio || "Brak szczegółowego biogramu.";

                const panelAge = document.getElementById('panelAge');
                if (data.age) {
                    panelAge.textContent = `Wiek: ${data.age} lat`;
                    panelAge.classList.remove('hidden');
                } else {
                    panelAge.classList.add('hidden');
                }

                // Region Label Color
                const regLabel = document.getElementById('panelRegion');
                regLabel.style.backgroundColor = rank.color;
                regLabel.style.color = (rank.class === 'pin-gradient-gold') ? '#000' : '#fff';

                if (data.country.includes("NATO") || data.country.includes("ONZ") ||
                    data.country.includes("UE") || data.country.includes("OECD")) {
                    regLabel.textContent = "STAŁE PRZEDSTAWICIELSTWO";
                } else if (data.title.includes("Konsul")) {
                    regLabel.textContent = "KONSULAT GENERALNY";
                } else if (data.country.includes("Biuro")) {
                    regLabel.textContent = "BIURO POLSKIE";
                } else {
                    regLabel.textContent = "AMBASADA RP";
                }

                // Icon Background
                const iconBg = document.getElementById('panelIconBg');
                iconBg.style.background = rank.class === 'pin-gradient-gold' ?
                    'linear-gradient(135deg, #E6C870 0%, #C4A462 100%)' :
                    'linear-gradient(135deg, #7A8B9D 0%, #5F6F81 100%)';

                elements.infoPanel.classList.remove('hidden');
                elements.infoPanel.setAttribute('aria-hidden', 'false');
                setTimeout(() => {
                    elements.infoPanel.classList.remove('translate-x-full');
                }, 10);
            }

            /**
             * Toggle sidebar visibility (mobile)
             */
            function toggleSidebar(show) {
                if (show) {
                    elements.sidebar.classList.remove('-translate-x-full');
                    elements.sidebarToggle.setAttribute('aria-expanded', 'true');
                } else {
                    elements.sidebar.classList.add('-translate-x-full');
                    elements.sidebarToggle.setAttribute('aria-expanded', 'false');
                }
            }

            /**
             * Set gender filter
             */
            function setGenderFilter(val) {
                state.gender = val;

                // Update button states and ARIA attributes
                const buttons = [elements.filterAll, elements.filterWomen, elements.filterMen];
                buttons.forEach(btn => {
                    btn.classList.remove('active');
                    btn.setAttribute('aria-pressed', 'false');
                });

                if (val === 'all') {
                    elements.filterAll.classList.add('active');
                    elements.filterAll.setAttribute('aria-pressed', 'true');
                }
                if (val === 'F') {
                    elements.filterWomen.classList.add('active');
                    elements.filterWomen.setAttribute('aria-pressed', 'true');
                }
                if (val === 'M') {
                    elements.filterMen.classList.add('active');
                    elements.filterMen.setAttribute('aria-pressed', 'true');
                }

                updateView();
            }

            /**
             * Toggle age filter
             */
            function toggleAgeFilter() {
                state.ageFilter = elements.ageFilter.checked;
                updateView();
            }

            /**
             * Attach event listeners
             */
            function attachEventListeners() {
                // Search input with debouncing for better performance
                const debouncedSearch = debounce(() => {
                    state.searchTerm = elements.searchInput.value;
                    renderList();
                }, 300);

                elements.searchInput.addEventListener('input', debouncedSearch);

                // Panel close button
                elements.closePanel.addEventListener('click', () => {
                    elements.infoPanel.classList.add('translate-x-full');
                    elements.infoPanel.setAttribute('aria-hidden', 'true');
                });

                // Sidebar toggle (mobile)
                elements.sidebarToggle.addEventListener('click', () => toggleSidebar(true));
                elements.closeSidebarBtn.addEventListener('click', () => toggleSidebar(false));

                // Close panel on Escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        if (!elements.infoPanel.classList.contains('translate-x-full')) {
                            elements.closePanel.click();
                        }
                    }
                });
            }

            /**
             * Initialize the application
             */
            async function init() {
                try {
                    cacheElements();

                    const dataLoaded = await loadData();
                    if (!dataLoaded) return;

                    const mapInitialized = initMap();
                    if (!mapInitialized) return;

                    await loadGeoJSON();

                    addMarkers();
                    renderList();
                    calculateStats();
                    attachEventListeners();

                    hideLoading();

                } catch (error) {
                    console.error('Initialization error:', error);
                    showError('Wystąpił nieoczekiwany błąd podczas inicjalizacji aplikacji.');
                }
            }

            // Public API
            return {
                init,
                setGenderFilter,
                toggleAgeFilter
            };
        })();

        // Initialize app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', AmbassadorMap.init);
        } else {
            AmbassadorMap.init();
        }
    </script>
</body>
</html>
